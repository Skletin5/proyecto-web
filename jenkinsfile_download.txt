pipeline {
    agent any
    
    stages {
        stage('Clonación de repositorio') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/Skletin5/proyecto-web.git'
            }
        }
        stage('exportación de BD') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'DB_Data', passwordVariable: 'BD_ROOT_PASSWD', usernameVariable: 'BD_NAME')]) {
                    sh 'docker exec proyecto-web-download_db_1 mysqldump -u root -p$BD_ROOT_PASSWD $BD_NAME > db-backup.sql'
                }
            }
        }
        stage('copiar contenido del wordpress') {
            steps {
                sh 'docker cp proyecto-web-download_wordpress_1:/var/www/html/wp-content ./'
                sh 'docker cp proyecto-web-download_wordpress_1:/var/www/html/wp-config.php .'
            }
        }
        stage('Identificar a jenkins') {
            steps {
                sh 'git config --global user.name "Jenkins"'
                sh 'git config --global user.email "jenkins@example.com"'
            }
        }
        stage('Push al repositorio') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'DockerHub', passwordVariable: 'TOKEN', usernameVariable: 'USERNAME')]) {
                    sh 'git add db-backup.sql'
                    sh 'git add wp-config.php'
                    sh 'git add wp-content'
                    sh 'git commit -m "Backup automático: $(date +%Y-%m-%d_%H-%M)"'
                    sh 'git push https://$USERNAME:$TOKEN@github.com/Skletin5/proyecto-web.git main'
                }    
            }
        }
    }
}
